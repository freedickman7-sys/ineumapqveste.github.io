<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Map Viewer</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: #222;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    #viewer {
      position: relative;
      overflow: hidden;
      flex: 1;
      width: 100%;
      height: 100%;
      touch-action: none;
    }
    #map {
      transform-origin: center center;
      transition: transform 0.05s linear;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    .icon {
      position: absolute;
      width: 40px;
      height: 40px;
      transform: translate(-50%, -50%);
      pointer-events: none;
    }
    .buttons {
      display: flex;
      gap: 10px;
      margin: 10px;
      z-index: 100;
    }
    .buttons button {
      padding: 8px 14px;
      font-size: 14px;
      border-radius: 8px;
      border: none;
      background: #444;
      color: white;
    }
  </style>
</head>
<body>
  <div class="buttons">
    <button onclick="switchMap(0)">Карта 1</button>
    <button onclick="switchMap(1)">Карта 2</button>
    <button onclick="switchMap(2)">Карта 3</button>
    <button onclick="switchMap(3)">Карта 4</button>
  </div>
  <div id="viewer">
    <img id="map" src="images/map1.png" alt="map">
  </div>

  <script>
    const maps = [
      { src: "images/map1.png", icons: [ {x:100,y:100,enabled:true}, {x:200,y:200,enabled:false}, {x:0,y:0,enabled:false} ] },
      { src: "images/map2.png", icons: [ {x:150,y:150,enabled:true}, {x:250,y:250,enabled:true} ] },
      { src: "images/map3.png", icons: [ {x:180,y:120,enabled:true} ] },
      { src: "images/map4.png", icons: [ {x:0,y:0,enabled:false} ] }
    ];
    const mapImg = document.getElementById("map");
    const viewer = document.getElementById("viewer");
    let currentMap = 0;
    let scale = 1, rotation = 0, posX = 0, posY = 0;

    function switchMap(index) {
      currentMap = index;
      mapImg.src = maps[currentMap].src;
      document.querySelectorAll(".icon").forEach(el => el.remove());
      addIcons();
      resetTransform();
    }

    function resetTransform() {
      scale = 1; rotation = 0; posX = 0; posY = 0;
      updateTransform();
    }

    function updateTransform() {
      mapImg.style.transform =
        `translate(-50%, -50%) translate(${posX}px, ${posY}px) scale(${scale}) rotate(${rotation}deg)`;
      updateIcons();
    }

    function addIcons() {
      maps[currentMap].icons.forEach((icon, i) => {
        if (!icon.enabled || icon.x === 0 && icon.y === 0) return;
        const el = document.createElement("img");
        el.src = "images/icon.png"; // одна иконка для всех, можно заменить
        el.className = "icon";
        el.dataset.x = icon.x;
        el.dataset.y = icon.y;
        viewer.appendChild(el);
      });
    }

    function updateIcons() {
      document.querySelectorAll(".icon").forEach(el => {
        const x = parseFloat(el.dataset.x);
        const y = parseFloat(el.dataset.y);
        const rect = mapImg.getBoundingClientRect();
        const cx = rect.left + rect.width / 2;
        const cy = rect.top + rect.height / 2;
        const dx = (x - rect.width / 2) * scale;
        const dy = (y - rect.height / 2) * scale;
        const angle = rotation * Math.PI / 180;
        const rotatedX = dx * Math.cos(angle) - dy * Math.sin(angle);
        const rotatedY = dx * Math.sin(angle) + dy * Math.cos(angle);
        el.style.left = `${cx + rotatedX + posX}px`;
        el.style.top = `${cy + rotatedY + posY}px`;
        el.style.transform = `translate(-50%, -50%) scale(${scale}) rotate(${-rotation}deg)`;
      });
    }

    // Жесты для телефонов
    let lastTouchDist = null, lastTouchAngle = null, lastTouchCenter = null;
    viewer.addEventListener("touchstart", e => {
      if (e.touches.length === 2) {
        lastTouchDist = getTouchDist(e);
        lastTouchAngle = getTouchAngle(e);
        lastTouchCenter = getTouchCenter(e);
      }
    });
    viewer.addEventListener("touchmove", e => {
      e.preventDefault();
      if (e.touches.length === 1) {
        posX += e.touches[0].movementX || 0;
        posY += e.touches[0].movementY || 0;
        updateTransform();
      } else if (e.touches.length === 2) {
        const dist = getTouchDist(e);
        const angle = getTouchAngle(e);
        if (lastTouchDist) scale *= dist / lastTouchDist;
        if (lastTouchAngle) rotation += angle - lastTouchAngle;
        lastTouchDist = dist;
        lastTouchAngle = angle;
        updateTransform();
      }
    }, { passive: false });

    function getTouchDist(e) {
      const dx = e.touches[0].clientX - e.touches[1].clientX;
      const dy = e.touches[0].clientY - e.touches[1].clientY;
      return Math.sqrt(dx*dx + dy*dy);
    }
    function getTouchAngle(e) {
      const dx = e.touches[0].clientX - e.touches[1].clientX;
      const dy = e.touches[0].clientY - e.touches[1].clientY;
      return Math.atan2(dy, dx) * 180 / Math.PI;
    }
    function getTouchCenter(e) {
      return {
        x: (e.touches[0].clientX + e.touches[1].clientX) / 2,
        y: (e.touches[0].clientY + e.touches[1].clientY) / 2
      };
    }

    switchMap(0);
  </script>
</body>
</html>
